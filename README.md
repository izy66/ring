# Ring

A Sage Math implementation of the accountable ring signature protocol proposed in https://doi.org/10.1007/978-3-030-92548-2_10 and https://eprint.iacr.org/2022/1293.

## Dependencies:

https://github.com/pyca/cryptography/

## Test Run:

To test the correctness of the program, run

```
load('main.py')
```

in a Sage interactive shell.


## Introduction

The notion of ring signature was first proposed in 2001 [RST01]. The goal is to achieve signature anomity by hiding signer's identity among a "ring" of possible signers.

Accountable ring signature was introduced in 2015 [BCCGGP15], where a trusted tracer may reveal the identity behind a ring signature. This approach is further improved by Fraser and Quaglia to ensure that the tracer acts faithfully, by introducing a report mechanism, so that both the tracer and one ring member must be involved to decrypt a signature.

## Outline

During the key setup stage, each member $\text{u}$ generates a pair of PKE keys $(PK_\text{u}, SK_\text{u})$, and a corresponding identity key $(PID_u)$. The ring $\text{R}$ is then defined as $(PK_\text{U}, PID_\text{U})$ where $\text{U}$ is the collection of ring members. The tracer generates his PKE keys $(PK_\text{T}, SK_\text{T})$.

To sign a message, a signer $\text{u}$ generates a fresh PKE key pair $(PK_\text{sign}, SK_\text{sign})$, and encrypts the secret signing key to each ring member. He later double encrypts his identity $PID_{\text{u}}$ under $PK_\text{T}$ and $PK_{\text{sign}}$.

To report a malicious message, a reporter in the ring would decrypt $SK_{\text{sign}}$ with her secret PKE key, and send it to the tracer. At last the tracer will decrypt $PID_{\text{sign}}$ with $SK_\text{sign}$ and $SK_\text{T}$.

## Zero-knowedge Proofs

ZK proofs are introduced to ensure the integrity of protocol execution. They are summarized as follows:

1. Key Encryption Stage: The signer proves correct encryption of $PK_\text{sign}$.
2. Identity Encryption Stage: The signer proves his membership, and proves correct encryption of his own $PID_\text{u}$.
3. Reporting Stage: The reporter proves correct decryption of $SK_\text{sign}$. (However, this proof is not explicitly instantiated, as explained in the next section).
4. Tracing Stage: The tracer proves correct decryption of $PID_\text{u}$ using $SK_\text{sign}$ and $SK_\text{T}$.

## Implementation 

The PKE scheme used by encrypting $SK_\text{sign}$ and $PID_\text{u}$ are variants of ElGamal on elliptic curve groups of prime order. In particular, we combined with bilinear pairings on elliptic curves to simplify and improve ZK complexity. 

Let $e: G_1 \times G_2 \to G_T$ be a Type-3 pairing. Let $g_1, g_2, g_t \leftarrow e(g_1, g_2)$ be generators of $G_1, G_2, G_T$, where $G_1, G_2$ are r-torsion groups on $\mathbb{E}(q^k)$, and $G_T$ is a cyclic subgroup of order $r$ in $\mathbb{F}(q^k)$. Then $(PK_\text{u}, SK_\text{u}, PID_\text{u}) \in (G_1, \mathbb{Z}/r\mathbb{Z}, G_t)$ is generated by

$$
SK_\text{u} \overset{\$}{\longleftarrow} \mathbb{Z}/r\mathbb{Z}, PK_\text{u} \leftarrow g_1^{SK_\text{u}},
PID_\text{u} \leftarrow g_3^{SK_\text{u}}.
$$

Similarly $(PK_{\text{T}}, SK_\text{T}) \in (G_T, \mathbb{Z}/r\mathbb{Z})$ is generated as

$$
SK_\text{T} \overset{\$}{\longleftarrow} \mathbb{Z}/r\mathbb{Z}, PK_\text{T} \leftarrow g_3^{SK_\text{T}}.
$$

A signing key pair $(PK_\text{sign}, SK_\text{sign}) \in (G_T, G_1)$ is generated by

$$
r \overset{\$}{\longleftarrow} \mathbb{Z}/r\mathbb{Z}, 
SK_\text{sign} \leftarrow g_1^{r},
PK_\text{sign} \leftarrow g_3^{r} = e(SK_\text{sign}, g_2).
$$

To sign a message $m$, the signer encrypts his secret signing key under the following scheme:

$$
c : r \overset{\$}{\longleftarrow} \mathbb{Z}/r\mathbb{Z}, 
(c_1,c_2) \leftarrow (g_1^r, PK_\text{u}^r \cdot SK_\text{sign}),
$$

which is exactly standard ElGamal on $G_1$. To prove correct encryption without revealing $r$, the signer needs to prove that

$$
\begin{align*}
  \rho : \text{ } & PK_\text{sign} = e(Dec(SK_\text{u}, (c_1, c_2), g_2)) \\
  \Leftrightarrow & PK_\text{sign} = e\left(\frac{c_2}{c_1^{SK_\text{u}}}, g_2\right) = \frac{e(c_2, g_2)}{e\left(g_1^{r \cdot SK_\text{u}}, g_2\right)} = \frac{e(c_2, g_2)}{e(PK_\text{u}, g_2)^r} \\
  \Leftrightarrow & e(PK_\text{u}, g_2)^r = \frac{e(c_2, g_2)}{PK_\text{sign}}
\end{align*}
$$

which can be implemented by applying Fiat-Shamir transform on Schnorr's protocol.

Next the signer encrypts his $PID_\text{u}$ under $PK_\text{T}$ and $PK_\text{sign}$ by the following scheme:

$$
r_2, r_3 \overset{\$}{\longleftarrow} \mathbb{Z} / r\mathbb{Z}
$$
$$
d : (c_1, c_2, c_3) \leftarrow (g_3 ^ {r_2}, g_2 ^ {r_3}, PK_\text{T} ^ {r_2} \cdot PK_\text{sign} ^ {r_3} \cdot PID_\text{u})
$$

and the decryption scheme is 

$$
PID_\text{u} \leftarrow \frac{c_3}{e(SK_\text{sign}, c_2) \cdot c_1 ^ {SK_\text{T}}}
$$

The signer needs to prove that he is a member of the ring, and he has faithfully encrypted his own public identity. This is summarized by the following relations:

$$
\begin{align*}
   \sigma : \text{ } & \{(SK_{\text{u}}, \text{u}): PID_\text{u} = g_3 ^ {SK_\text{u}} \land \text{u} \in \text{R}\} \\
   & \{(r_2, r_3, \text{u}): PK_\text{T} ^ {r_2} \cdot PK_\text{sign} ^ {r_3} = \frac{c_3}{PID_\text{u}} \land \text{u} \in \text{R}\}
\end{align*}
$$

which can be implemented by applying Fiat-Shamir transform on Schnorr's and Okamoto's protocol with respect to OR relations.

The signature is then composed of $(PK_\text{sign}, c, d, \rho, \sigma)$. Note that any third parties should be able to verify this signature and conclude that one of the ring members signed it, without knowing which one exactly.

We mentioned before that the reporter decrypts $SK_\text{sign}$ without proving correctness, since anyone can check the following relation holds, assuming DLOG in $G_T$ is hard:

$$
PK_\text{sign} = e(SK_\text{sign}, g_2)
$$

Lastly the tracer needs to prove correct decryption of $PID_\text{u}$ by proving the relation

$$
\{SK_\text{T}: PK_\text{T} = g_3 ^{SK_\text{T}} \land c_1 ^ {SK_\text{T}} = \frac{c_3}{e(SK_\text{sign}, c_2) \cdot PID_\text{u}}\}
$$

which is implemented by applying Fiat-Shamir on Schnorr's protocol.

## Security Disclaims !

This project is written in fullfilment of CO 485/685 at Waterloo, and nothing else beyond corretness of protocol is ensured. The source has been tested and benchmarked on the Apple Silicon M1 platform, with Sage version 9.6.

## Benchmark

The benchmark is performed on a ring of 50 members. The signature is generated for a single message of 16 bytes.

| function               | time (s) |
|------------------------|-------|
| signing                | 1.588 |
| signature verification | 3.850 |
| reporting              | 3.830 |
| tracing                | 3.868 |
| trace verification     | 3.871 |
